// ==UserScript==
// @name         Nexus Bridge: Meta AI (Facebook Sidecar)
// @version      1.1
// @description  Extrahiert Meta AI Chat-Antworten für die barrierefreie Audio-Resonanz im Nexus-System.
// @author       Architekt & Gee
// @match        https://www.facebook.com/*
// @match        https://www.meta.ai/*
// @match        https://www.messenger.com/*
// @grant        GM_xmlhttpRequest
// @connect      127.0.0.1
// @noframes     false
// ==/UserScript==

(function() {
    'use strict';
    const ENDPOINT = "http://127.0.0.1:8002/";
    let lastSentContent = "";
    let typingTimer = null;

    const observer = new MutationObserver(() => {
        // Wir nutzen deinen Gold-Fund: Den exakten Meta-Container
        const metaNodes = document.querySelectorAll('p.xat24cr.xdj266r');
        if (metaNodes.length === 0) return;

        // Die aktuellste Nachricht ist immer die letzte in der Liste
        const latestNode = metaNodes[metaNodes.length - 1];
        const currentText = latestNode.innerText.trim();

        // 1. BASIS-FILTER
        if (currentText.length < 3 || currentText === lastSentContent) return;

        // 2. SPIEGEL-SCHUTZ (Damit der Nexus dich ignoriert)
        const isUser = latestNode.closest('[aria-label*="Du"], [aria-label*="You"]') ||
                       window.getComputedStyle(latestNode).textAlign === "right" ||
                       window.getComputedStyle(latestNode.parentElement).justifyContent === "flex-end";

        if (isUser) return;

        // 3. RESONANZ-TIMER (Warten auf das Ende des KI-Streams)
        clearTimeout(typingTimer);
        typingTimer = setTimeout(() => {
            if (currentText !== lastSentContent) {
                lastSentContent = currentText;
                console.log("[NEXUS] Meta-KI spricht: " + currentText.substring(0, 40));
                sendToNexus(currentText);
            }
        }, 3000);
    });

    function sendToNexus(t) {
        // Bereinigung von Emojis für flüssiges Vorlesen
        const cleanText = t.replace(/[\u{1F600}-\u{1F64F}]/gu, "").trim();

        GM_xmlhttpRequest({
            method: "POST",
            url: ENDPOINT,
            data: JSON.stringify({ text: cleanText }),
            headers: { "Content-Type": "application/json" },
            onload: r => console.log("[NEXUS OK]"),
            onerror: e => console.error("[NEXUS ERR] Butler offline?")
        });
    }

    observer.observe(document.body, { childList: true, subtree: true });
})();
