// ==UserScript==
// @name         Nexus Bridge: Meta AI (Facebook Sidecar)
// @version      1.1
// @description  Extrahiert Meta AI Chat-Antworten für die barrierefreie Audio-Resonanz im Nexus-System.
// @author       Architekt & Gee
// @match        https://www.facebook.com/*
// @match        https://www.meta.ai/*
// @match        https://www.messenger.com/*
// @grant        GM_xmlhttpRequest
// @grant        unsafeWindow
// @connect      localhost
// @connect      127.0.0.1
// @noframes     false
// ==/UserScript==


(function() {
    'use strict';
    const ENDPOINT = "http://127.0.0.1:8002/";
    let lastProcessedNode = null;
    let lastSentContent = "";
    let typingTimer = null;

    const observer = new MutationObserver(() => {
        // Wir suchen in den Standard-Containern
        const nodes = document.querySelectorAll('div[role="presentation"] div[dir="auto"], p.xat24cr.xdj266r');
        if (nodes.length === 0) return;

        const validNodes = Array.from(nodes).filter(node => {
            const text = node.innerText.trim();
            const isTimestamp = /^\d{1,2}:\d{2}$/.test(text);
            return !isTimestamp && text.length > 3;
        });

        if (validNodes.length === 0) return;

        const latestNode = validNodes[validNodes.length - 1];
        const currentText = latestNode.innerText.trim();

        // 1. GEISTER-STOPP
        if (latestNode === lastProcessedNode && currentText === lastSentContent) return;

        // 2. ULTRA-SPIEGEL-SCHUTZ (Der Fix für Firefox)
        const style = window.getComputedStyle(latestNode);
        const parentStyle = window.getComputedStyle(latestNode.parentElement);

        const isUser =
            latestNode.closest('[aria-label*="Du"], [aria-label*="You"]') || // ARIA-Check
            style.textAlign === "right" || // Text-Ausrichtung
            parentStyle.justifyContent.includes("end") || // Flex-Ausrichtung (Deine Seite)
            latestNode.closest('[style*="background-color: rgb(0, 132, 255)"]'); // FB-Blau Check

        // NEU: Ignoriere alles, was im Eingabefeld (Editor) steht
        const isTyping = latestNode.isContentEditable || latestNode.closest('[role="textbox"]');

        if (isUser || isTyping) {
            return; // Butler schweigt bei dir
        }

        // 3. BOT-CHECK & DEBOUNCE
        if (currentText !== lastSentContent) {
            clearTimeout(typingTimer);
            typingTimer = setTimeout(() => {
                lastSentContent = currentText;
                lastProcessedNode = latestNode;
                console.log("[NEXUS] Meta-Nachricht stabilisiert: " + currentText.substring(0, 30));
                sendToNexus(currentText);
            }, 3500); // 3.5 Sek warten, damit Meta den Satz fertig baut
        }
    });

    function sendToNexus(t) {
        const speechText = t.replace(/\uD83D\uDE0A/g, "").trim();
        GM_xmlhttpRequest({
            method: "POST",
            url: ENDPOINT,
            data: JSON.stringify({ text: speechText }),
            headers: { "Content-Type": "application/json" },
            onload: r => console.log(`[NEXUS OK]`),
            onerror: e => console.error("[NEXUS ERR]", e)
        });
    }

    observer.observe(document.body, { childList: true, subtree: true, characterData: true });
})();
